# SecurityAgent Dockeræ‰©å±•é…ç½®
# ç”¨äºåœ¨OpenHandsè¿è¡Œæ—¶ç¯å¢ƒä¸­æ·»åŠ å®‰å…¨åˆ†æå·¥å…·

# åŸºäºç°æœ‰çš„OpenHands runtimeé•œåƒ
ARG BASE_IMAGE=docker.all-hands.dev/all-hands-ai/runtime:0.44-nikolaik
FROM ${BASE_IMAGE}

# ç»´æŠ¤è€…ä¿¡æ¯
LABEL maintainer="OpenHands SecurityAgent"
LABEL description="OpenHands Runtime with Security Analysis Tools"
LABEL version="1.0"

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DEBIAN_FRONTEND=noninteractive
ENV AFL_SKIP_CPUFREQ=1
ENV AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES=1
ENV PYTHONPATH="${PYTHONPATH}:/workspace"

# æ›´æ–°åŒ…ç®¡ç†å™¨
RUN apt-get update

# ===== å®‰è£…åŸºç¡€å¼€å‘å·¥å…· =====
RUN apt-get install -y \
    build-essential \
    python3-dev \
    python3-pip \
    python3-setuptools \
    gcc-multilib \
    libtool \
    automake \
    autoconf \
    bison \
    libglib2.0-dev \
    libpixman-1-dev \
    clang \
    llvm \
    clang-11 \
    llvm-11 \
    llvm-11-dev \
    llvm-11-tools \
    git \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ===== å®‰è£…AFL++ =====
RUN cd /tmp && \
    git clone https://github.com/AFLplusplus/AFLplusplus.git && \
    cd AFLplusplus && \
    make distrib && \
    make install && \
    cd / && \
    rm -rf /tmp/AFLplusplus

# ===== å®‰è£…GDBå’Œè°ƒè¯•å·¥å…· =====
RUN apt-get update && apt-get install -y \
    gdb \
    gdb-multiarch \
    valgrind \
    ltrace \
    strace \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…GDBå¢å¼ºæ’ä»¶å’ŒPythonä¾èµ–
RUN pip3 install --no-cache-dir \
    pwntools \
    ropper \
    keystone-engine \
    capstone \
    unicorn

# å®‰è£…pwndbgï¼ˆGDBå¢å¼ºæ’ä»¶ï¼‰
RUN cd /opt && \
    git clone https://github.com/pwndbg/pwndbg && \
    cd pwndbg && \
    ./setup.sh && \
    echo "source /opt/pwndbg/gdbinit.py" >> ~/.gdbinit

# ===== å®‰è£…KLEEä¾èµ– =====
RUN apt-get update && apt-get install -y \
    z3 \
    libz3-dev \
    python3-z3 \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…KLEEæ„å»ºå·¥å…·
RUN pip3 install --no-cache-dir wllvm

# ===== å®‰è£…äºŒè¿›åˆ¶åˆ†æå·¥å…· =====
RUN apt-get update && apt-get install -y \
    file \
    binutils \
    binutils-dev \
    elfutils \
    radare2 \
    binwalk \
    foremost \
    hexdump \
    xxd \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…checksec
RUN cd /tmp && \
    wget https://github.com/slimm609/checksec.sh/archive/refs/heads/main.zip && \
    unzip main.zip && \
    cp checksec.sh-main/checksec /usr/local/bin/ && \
    chmod +x /usr/local/bin/checksec && \
    rm -rf checksec.sh-main main.zip

# ===== å®‰è£…KLEE (ç®€åŒ–ç‰ˆæœ¬) =====
# æ³¨æ„ï¼šå®Œæ•´çš„KLEEç¼–è¯‘éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œè¿™é‡Œæä¾›åŸºç¡€é…ç½®
# ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½éœ€è¦ä½¿ç”¨é¢„ç¼–è¯‘ç‰ˆæœ¬æˆ–åœ¨ç‹¬ç«‹çš„æ„å»ºæ­¥éª¤ä¸­å®Œæˆ

# åˆ›å»ºKLEEç¬¦å·é“¾æ¥å’ŒåŸºç¡€é…ç½®
RUN mkdir -p /opt/klee && \
    echo "#!/bin/bash" > /usr/local/bin/klee && \
    echo "echo 'KLEE placeholder - install full KLEE for symbolic execution'" >> /usr/local/bin/klee && \
    echo "echo 'Use compile_for_klee() to prepare bitcode files'" >> /usr/local/bin/klee && \
    chmod +x /usr/local/bin/klee

# ktest-tool å ä½ç¬¦
RUN echo "#!/bin/bash" > /usr/local/bin/ktest-tool && \
    echo "echo 'ktest-tool placeholder - install full KLEE for test case analysis'" >> /usr/local/bin/ktest-tool && \
    chmod +x /usr/local/bin/ktest-tool

# ===== é…ç½®ç¯å¢ƒ =====
# è®¾ç½®AFL++ç¯å¢ƒå˜é‡
ENV AFL_PATH=/usr/local/lib/afl
ENV PATH=$PATH:/usr/local/lib/afl:/usr/local/bin

# åˆ›å»ºå®‰å…¨åˆ†æå·¥ä½œç›®å½•
RUN mkdir -p /workspace/security/{fuzzing/{input,output},crashes,symbolic,reports,tools}

# è®¾ç½®åˆç†çš„é»˜è®¤å€¼
ENV AFL_TMPDIR=/tmp
ENV AFL_TIMEOUT=60

# ===== æ·»åŠ è¾…åŠ©è„šæœ¬ =====
# åˆ›å»ºå®‰å…¨å·¥å…·æ£€æŸ¥è„šæœ¬
RUN cat > /usr/local/bin/check-security-tools << 'EOF'
#!/bin/bash
echo "=== SecurityAgent å·¥å…·æ£€æŸ¥ ==="
echo ""

echo "AFL++ å·¥å…·:"
which afl-fuzz && echo "  âœ“ afl-fuzz" || echo "  âœ— afl-fuzz"
which afl-cmin && echo "  âœ“ afl-cmin" || echo "  âœ— afl-cmin"
which afl-tmin && echo "  âœ“ afl-tmin" || echo "  âœ— afl-tmin"
echo ""

echo "GDB å·¥å…·:"
which gdb && echo "  âœ“ gdb" || echo "  âœ— gdb"
test -f ~/.gdbinit && echo "  âœ“ pwndbgé…ç½®" || echo "  âœ— pwndbgé…ç½®"
echo ""

echo "åˆ†æå·¥å…·:"
which checksec && echo "  âœ“ checksec" || echo "  âœ— checksec"
which objdump && echo "  âœ“ objdump" || echo "  âœ— objdump"
which readelf && echo "  âœ“ readelf" || echo "  âœ— readelf"
which file && echo "  âœ“ file" || echo "  âœ— file"
which strings && echo "  âœ“ strings" || echo "  âœ— strings"
echo ""

echo "KLEE å·¥å…·:"
which clang && echo "  âœ“ clang (LLVM)" || echo "  âœ— clang"
which klee && echo "  âœ“ klee (å ä½ç¬¦)" || echo "  âœ— klee"
echo ""

echo "Python å®‰å…¨åº“:"
python3 -c "import pwn; print('  âœ“ pwntools')" 2>/dev/null || echo "  âœ— pwntools"
python3 -c "import capstone; print('  âœ“ capstone')" 2>/dev/null || echo "  âœ— capstone"
python3 -c "import keystone; print('  âœ“ keystone')" 2>/dev/null || echo "  âœ— keystone"

echo ""
echo "å·¥ä½œç›®å½•:"
ls -la /workspace/security/ 2>/dev/null && echo "  âœ“ å®‰å…¨åˆ†æå·¥ä½œç›®å½•" || echo "  âœ— å®‰å…¨åˆ†æå·¥ä½œç›®å½•"
EOF

RUN chmod +x /usr/local/bin/check-security-tools

# åˆ›å»ºå¿«é€Ÿå®‰å…¨åˆ†æè„šæœ¬
RUN cat > /usr/local/bin/quick-security-scan << 'EOF'
#!/bin/bash
if [ -z "$1" ]; then
    echo "ç”¨æ³•: quick-security-scan <binary_file>"
    exit 1
fi

BINARY="$1"
echo "=== å¿«é€Ÿå®‰å…¨æ‰«æ: $BINARY ==="
echo ""

echo "æ–‡ä»¶ä¿¡æ¯:"
file "$BINARY"
echo ""

echo "å®‰å…¨ç‰¹æ€§:"
checksec --file="$BINARY" 2>/dev/null || echo "checksecä¸å¯ç”¨ï¼Œè·³è¿‡æ£€æŸ¥"
echo ""

echo "å±é™©å‡½æ•°æ£€æŸ¥:"
objdump -T "$BINARY" 2>/dev/null | grep -E "gets|strcpy|sprintf|system" || echo "æœªå‘ç°æ˜æ˜¾å±é™©å‡½æ•°"
echo ""

echo "åŸºç¡€åˆ†æå®Œæˆã€‚ä½¿ç”¨SecurityAgentè¿›è¡Œæ·±åº¦åˆ†æã€‚"
EOF

RUN chmod +x /usr/local/bin/quick-security-scan

# ===== æ¸…ç†å’Œä¼˜åŒ– =====
RUN apt-get autoremove -y && \
    apt-get autoclean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /workspace

# æ·»åŠ å¯åŠ¨ä¿¡æ¯
RUN echo 'echo "SecurityAgentç¯å¢ƒå·²å°±ç»ª ğŸ”’"' >> ~/.bashrc
RUN echo 'echo "è¿è¡Œ check-security-tools æ£€æŸ¥å·¥å…·çŠ¶æ€"' >> ~/.bashrc
RUN echo 'echo "è¿è¡Œ quick-security-scan <binary> è¿›è¡Œå¿«é€Ÿåˆ†æ"' >> ~/.bashrc

# é»˜è®¤å‘½ä»¤
CMD ["/bin/bash"]